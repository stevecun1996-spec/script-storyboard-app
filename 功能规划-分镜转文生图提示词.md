# 分镜转文生图提示词功能规划文档

## 📋 功能概述

将分镜脚本转换为适合 Nano Banana Pro 文生图模型的提示词，包含所有分镜字段信息，并参考镜头语言知识库。

---

## 🎨 UI布局规划

### 方案A：新增步骤（推荐）
```
当前流程：步骤1（输入剧本） → 步骤2（分镜编辑）
新流程：  步骤1（输入剧本） → 步骤2（分镜编辑） → 步骤3（生成提示词）
```

**优点**：
- 流程清晰，符合线性工作流
- 用户可以在编辑完分镜后再生成提示词
- 易于理解和操作

**步骤3界面布局**：
```
┌─────────────────────────────────────────┐
│  🎨 步骤3：生成文生图提示词              │
├─────────────────────────────────────────┤
│                                         │
│  [配置区域]                              │
│  - 提示词风格选择（下拉）                │
│  - 提示词语言（中文/英文/双语）          │
│  - 详细程度（简洁/标准/详细）            │
│  - 是否包含技术参数（相机、镜头等）      │
│  - 是否包含情绪氛围                      │
│                                         │
│  [批量生成区域]                          │
│  - 选择分镜范围（全部/选中/自定义）       │
│  - 生成按钮                              │
│                                         │
│  [预览区域]                              │
│  - 分镜列表（可展开查看提示词）           │
│  - 每个分镜显示：                        │
│    * 分镜描述预览                        │
│    * 生成的提示词（可复制）               │
│    * 复制按钮                            │
│                                         │
│  [导出区域]                              │
│  - 导出为TXT文件                         │
│  - 导出为JSON文件                        │
│  - 导出为Excel（新增提示词列）           │
└─────────────────────────────────────────┘
```

### 方案B：在步骤2中集成
在分镜编辑界面中，每个分镜下方添加"生成提示词"按钮

**优点**：
- 即时生成，无需切换步骤
- 可以边编辑边生成

**缺点**：
- 界面可能过于拥挤
- 批量操作不够方便

### 方案C：侧边栏功能
在侧边栏添加"提示词生成"选项卡

**优点**：
- 不占用主界面空间
- 可以随时访问

**缺点**：
- 可能不够显眼
- 与主流程分离

**推荐：方案A（新增步骤）**

---

## 📊 数据结构规划

### 1. 提示词生成配置
```python
prompt_config = {
    "style": "cinematic",  # 风格：cinematic, realistic, artistic, anime等
    "language": "bilingual",  # 语言：chinese, english, bilingual
    "detail_level": "standard",  # 详细程度：simple, standard, detailed
    "include_technical": True,  # 是否包含技术参数（相机、镜头、光圈等）
    "include_mood": True,  # 是否包含情绪氛围
    "include_characters": True,  # 是否包含人物信息
    "include_dialogue": False,  # 是否包含台词（通常文生图不需要）
    "include_sound": False,  # 是否包含音效（文生图不需要）
    "weight_format": "nano_banana",  # 权重格式：nano_banana, stable_diffusion等
}
```

### 2. 生成的提示词结构
```python
image_prompt = {
    "scene_number": 1,
    "positive_prompt": "正向提示词（描述想要的内容）",
    "negative_prompt": "反向提示词（描述不想要的内容）",
    "technical_params": {
        "shot_size": "中景",
        "camera_angle": "视平",
        "camera": "ARRI Alexa",
        "lens": "ARRI Master Primes",
        "aperture": "f/2.8",
        # ... 其他技术参数
    },
    "style_keywords": ["电影感", "专业摄影", "高质量"],
    "mood_keywords": ["紧张", "悬疑"],
    "composition_keywords": ["饱满构图", "引导视线"]
}
```

---

## 🔧 功能模块规划

### 1. 提示词生成模块 (`utils/prompt_generator.py`)

**核心类：`ImagePromptGenerator`**

**主要方法**：
```python
class ImagePromptGenerator:
    def __init__(self, config: Dict):
        """初始化生成器，加载配置和镜头语言知识"""
        pass
    
    def generate_prompt(self, scene: Dict) -> Dict:
        """为单个分镜生成提示词"""
        pass
    
    def generate_batch(self, scenes: List[Dict]) -> List[Dict]:
        """批量生成提示词"""
        pass
    
    def _build_positive_prompt(self, scene: Dict) -> str:
        """构建正向提示词"""
        pass
    
    def _build_negative_prompt(self, scene: Dict) -> str:
        """构建反向提示词"""
        pass
    
    def _extract_visual_elements(self, scene: Dict) -> Dict:
        """提取视觉元素（场景、人物、动作等）"""
        pass
    
    def _apply_lens_language_knowledge(self, scene: Dict) -> List[str]:
        """应用镜头语言知识，生成专业关键词"""
        pass
```

### 2. 提示词模板模块 (`config/image_prompt_templates.py`)

**包含**：
- 不同风格的提示词模板
- 镜头语言关键词映射表
- 技术参数到视觉描述的转换规则

### 3. 导出模块扩展 (`utils/export_utils.py`)

**新增方法**：
```python
def export_with_prompts(self, scenes: List[Dict], script: str) -> str:
    """导出包含提示词的分镜脚本"""
    pass
```

---

## 📝 提示词生成策略

### 1. 正向提示词结构（Nano Banana Pro格式）

```
[主体描述], [动作/姿态], [场景环境], [镜头语言], [技术参数], [情绪氛围], [风格关键词], [质量标签]
```

**示例**：
```
一个年轻女性坐在咖啡馆靠窗位置, 低头看手机表情焦虑, 现代咖啡厅室内环境, 中景构图视平角度, ARRI Alexa相机ARRI Master Primes镜头f/2.8光圈, 紧张不安的氛围, 电影感专业摄影, 高质量8k细节丰富
```

### 2. 反向提示词（Negative Prompt）

**通用反向提示词**：
```
低质量, 模糊, 失真, 变形, 多余的手指, 多余的手臂, 文字, 水印, 签名, 丑陋, 畸变, 错误, 低分辨率, 像素化, 噪点, 伪影
```

**根据场景动态添加**：
- 如果是室内场景，添加"室外环境"
- 如果是白天，添加"夜晚、黑暗"
- 如果是特写，添加"远景、全景"

### 3. 镜头语言知识应用

**景别转换**：
- 大远景 → "extreme wide shot, vast landscape, tiny figure"
- 特写 → "close-up, detailed facial expression, shallow depth of field"
- 中景 → "medium shot, waist up, balanced composition"

**摄影机角度转换**：
- 高位俯拍 → "high angle, top-down view, looking down"
- 低位仰拍 → "low angle, looking up, dramatic perspective"
- 斜拍 → "dutch angle, tilted frame, dynamic composition"

**运镜转换**：
- 固定 → "static camera, locked frame"
- 轨道推拉 → "dolly shot, smooth camera movement"
- 手持 → "handheld camera, slight camera shake, documentary style"

**相机/镜头转换**：
- ARRI Alexa → "cinematic color grading, film-like quality"
- ARRI Master Primes → "sharp focus, professional cinematography"
- f/2.8 → "shallow depth of field, bokeh background"

### 4. 情绪氛围转换

**情绪关键词映射**：
- 紧张 → "tense atmosphere, dramatic lighting, high contrast"
- 轻松 → "soft lighting, warm tones, relaxed mood"
- 悲伤 → "muted colors, melancholic atmosphere, low saturation"

---

## 🎯 可能遗漏的重要信息

### 1. Nano Banana Pro 特定要求
- [ ] API 接口格式（需要确认）
- [ ] 提示词长度限制
- [ ] 支持的权重语法（如 `(keyword:1.2)` 或 `[keyword]`）
- [ ] 是否需要特殊分隔符
- [ ] 是否支持负面提示词
- [ ] 图片尺寸要求
- [ ] 采样步数、CFG Scale 等参数

### 2. 用户体验优化
- [ ] 提示词预览（实时生成）
- [ ] 提示词编辑功能（用户可手动调整）
- [ ] 提示词模板保存/加载
- [ ] 批量复制功能
- [ ] 提示词长度统计
- [ ] 关键词高亮显示

### 3. 多语言支持
- [ ] 中文提示词生成
- [ ] 英文提示词生成
- [ ] 双语提示词生成
- [ ] 语言切换功能

### 4. 风格预设
- [ ] 电影风格（cinematic）
- [ ] 写实风格（realistic）
- [ ] 艺术风格（artistic）
- [ ] 动画风格（anime）
- [ ] 自定义风格模板

### 5. 技术参数处理
- [ ] 是否将技术参数转换为视觉描述
- [ ] 技术参数的权重设置
- [ ] 技术参数的可选性（用户可选择包含/排除）

### 6. 批量处理优化
- [ ] 进度显示
- [ ] 错误处理（某个分镜生成失败不影响其他）
- [ ] 部分生成（只生成选中的分镜）
- [ ] 重新生成功能

### 7. 导出格式
- [ ] TXT 格式（每行一个提示词）
- [ ] JSON 格式（结构化数据）
- [ ] Excel 格式（新增列）
- [ ] 批量图片生成脚本（如果支持API调用）

### 8. 性能考虑
- [ ] 提示词生成速度（可能需要缓存）
- [ ] 大量分镜的处理（是否需要分批）
- [ ] 内存占用

### 9. 错误处理
- [ ] 空分镜处理
- [ ] 缺失字段处理
- [ ] 生成失败重试机制
- [ ] 用户友好的错误提示

### 10. 配置管理
- [ ] 用户配置保存（localStorage 或 session state）
- [ ] 默认配置
- [ ] 配置导入/导出

---

## 🔄 工作流程

```
1. 用户完成分镜编辑
   ↓
2. 进入步骤3（生成提示词）
   ↓
3. 配置提示词生成参数
   - 选择风格
   - 选择语言
   - 选择详细程度
   - 选择包含的字段
   ↓
4. 选择要生成的分镜范围
   ↓
5. 点击"生成提示词"
   ↓
6. 系统处理：
   a. 提取分镜信息
   b. 应用镜头语言知识
   c. 构建正向提示词
   d. 构建反向提示词
   e. 应用风格模板
   ↓
7. 显示生成的提示词
   ↓
8. 用户可：
   - 预览提示词
   - 编辑提示词
   - 复制提示词
   - 导出提示词
```

---

## 📦 需要创建/修改的文件

### 新建文件
1. `utils/prompt_generator.py` - 提示词生成核心模块
2. `config/image_prompt_templates.py` - 提示词模板配置
3. `services/image_prompt_service.py` - 提示词生成服务（可选）

### 修改文件
1. `app.py` - 添加步骤3界面
2. `utils/export_utils.py` - 添加提示词导出功能
3. `config/prompts.py` - 可能需要添加提示词生成相关的提示词模板

---

## ❓ 需要确认的问题

1. **Nano Banana Pro 的具体格式要求是什么？**
   - API 接口地址？
   - 提示词格式规范？
   - 是否需要特殊参数？

2. **提示词语言偏好？**
   - 主要使用中文还是英文？
   - 是否需要双语支持？

3. **技术参数的权重？**
   - 相机、镜头、光圈等参数在提示词中的重要性？
   - 是否需要高权重强调？

4. **是否需要直接调用生成图片？**
   - 还是只生成提示词，由用户手动使用？
   - 如果支持API调用，需要配置什么？

5. **提示词长度限制？**
   - Nano Banana Pro 是否有长度限制？
   - 是否需要提供简洁版和详细版？

---

## 🎨 UI设计建议

### 颜色方案
- 主色调：保持与现有系统一致
- 提示词区域：使用代码块样式（等宽字体）
- 复制按钮：使用图标按钮，绿色表示成功

### 交互设计
- 提示词可展开/折叠
- 一键复制所有提示词
- 实时预览（输入配置后立即显示示例）
- 拖拽排序（如果需要）

### 响应式设计
- 移动端适配（如果支持）
- 不同屏幕尺寸的布局调整

---

## 📈 未来扩展

1. **AI优化提示词**
   - 使用LLM优化生成的提示词
   - 根据生成结果反馈优化

2. **提示词库**
   - 保存常用提示词模板
   - 分享提示词模板

3. **图片预览**
   - 如果支持API调用，可以预览生成的图片
   - 图片对比功能

4. **批量图片生成**
   - 一键生成所有分镜的图片
   - 图片管理功能

---

## ✅ 实施优先级

### Phase 1（核心功能）
1. ✅ 基础提示词生成模块
2. ✅ 步骤3 UI界面
3. ✅ 正向提示词生成
4. ✅ 基础导出功能

### Phase 2（增强功能）
1. ⏳ 反向提示词生成
2. ⏳ 多种风格模板
3. ⏳ 提示词编辑功能
4. ⏳ 批量处理优化

### Phase 3（高级功能）
1. ⏳ 多语言支持
2. ⏳ 配置保存/加载
3. ⏳ 提示词优化（AI辅助）
4. ⏳ 图片生成集成（如果支持）

---

## 📝 注意事项

1. **保持向后兼容**：新功能不应影响现有功能
2. **性能优化**：大量分镜时需要考虑性能
3. **错误处理**：完善的错误提示和处理机制
4. **用户体验**：界面简洁，操作直观
5. **可扩展性**：为未来功能扩展预留接口

---

**请确认以上规划是否符合您的需求，特别是 Nano Banana Pro 的具体要求，这样我可以更准确地实现功能。**
